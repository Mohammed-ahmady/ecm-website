{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - ECM Website{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart_styles.css' %}">
{% endblock %}

{% block content %}
<div class="cart-detail-page">
<div class="main-container">
    <!-- Header Section -->
    <header class="header-section">
        <a href="{% url 'parts:part_list' %}" class="continue-shopping">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Continue shopping
        </a>
        <div class="wave-background"></div>
    </header>

    {% if cart_items %}
        <div class="content-wrapper">
            <!-- Left Section: Shopping Cart Items -->
            <section class="left-section">
                <h1 class="shopping-cart-title">Shopping cart <span class="item-count">{{ total_items }} item{{ total_items|pluralize }}</span></h1>
                
                {% for item in cart_items %}
                <div class="cart-item" data-part-id="{{ item.part.id }}">
                    <div class="product-image">
                        {% if item.part.image %}
                            <img src="{{ item.part.image.url }}" alt="{{ item.part.name }}">
                        {% else %}
                            <img src="{% static 'images/magirus.jpeg' %}" alt="{{ item.part.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        {% endif %}
                    </div>
                    <div class="product-details">
                        <h3 class="product-name">
                            <a href="{% url 'parts:part_detail' item.part.slug %}">{{ item.part.name }}</a>
                        </h3>
                        <p class="product-info">Part #: {{ item.part.part_number }}</p>
                    </div>
                    <div class="product-price">
                        {% if item.part.price %}
                            EGP {{ item.part.price }}
                        {% else %}
                            Price on request
                        {% endif %}
                    </div>
                    <div class="quantity-controls">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="qty-label" style="font-size: 0.9rem; margin-right: 0.3rem;">Qty.</span>
                            <button type="button" class="quantity-btn decrease-btn" data-action="decrease" data-part-id="{{ item.part.id }}">
                                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                            </button>
                            <span class="quantity-display" id="quantity-{{ item.part.id }}">{{ item.quantity }}</span>
                            <button type="button" class="quantity-btn increase-btn" data-action="increase" data-part-id="{{ item.part.id }}">
                                <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        {% if item.part.price %}
                            <span class="item-total" style="font-weight: 600;">EGP {{ item.total_price }}</span>
                        {% endif %}
                        <button type="button" class="remove-item-btn remove-btn" data-part-id="{{ item.part.id }}">
                            <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </section>

            <!-- Right Section: Order Summary -->
            <section class="right-section">
                <div class="address-details">
                    <p class="customer-name">Customer Information</p>
                    <p>Delivery Address</p>
                    <p>To be filled at checkout</p>
                    <a href="#" class="edit-btn">Edit</a>
                </div>

                <div class="payment-method">
                    <p class="payment-title">Payment method <span class="info-icon">&#9432;</span></p>
                    <p class="card-details">To be selected at checkout</p>
                    <a href="#" class="edit-btn">Edit</a>
                </div>

                <div class="discount-code">
                    <p class="discount-title">Do you have any discount code?</p>
                    <p class="discount-info">Only one discount code per order can be applied.</p>
                    <div class="discount-input-group">
                        <input type="text" placeholder="Your code here" class="discount-input" id="discount-code-input">
                        <button class="apply-btn" id="apply-discount-btn">APPLY</button>
                    </div>
                </div>

                <div class="order-summary">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal ({{ total_items }} items)</span>
                        <span class="summary-value" id="cart-subtotal">EGP {{ total_price }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Shipping costs</span>
                        <span class="summary-value">Calculated at checkout</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Discount</span>
                        <span class="summary-value">-</span>
                    </div>
                    <div class="summary-total">
                        <span class="total-label">Total (incl. VAT)</span>
                        <span class="total-value" id="cart-total">EGP {{ total_price }}</span>
                    </div>
                    <a href="{% url 'parts:checkout_page' %}" class="checkout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        CHECKOUT
                    </a>
                </div>
            </section>
        </div>
    {% else %}
        <!-- Empty Cart -->
        <div class="empty-cart">
            <svg class="empty-cart-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <h3>Your cart is empty</h3>
            <p>Looks like you haven't added anything to your cart yet.</p>
            <a href="{% url 'parts:part_list' %}" class="start-shopping-btn">
                <svg style="width: 1rem; height: 1rem; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                </svg>
                Start Shopping
            </a>
        </div>
    {% endif %}
</div>

{% csrf_token %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded");
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log("CSRF Token:", csrfToken ? "Found" : "Not found");
    
    // Initialize the cart functionality
    setupCartFunctionality();
    setupDiscountCode();
    setupStyleEffects();
    
    // Main cart functionality
    function setupCartFunctionality() {
        // Handle quantity changes with direct click handlers
        document.querySelectorAll('.increase-btn, .decrease-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const partId = this.getAttribute('data-part-id');
                const action = this.getAttribute('data-action');
                const changeAmount = action === 'increase' ? 1 : -1;
                
                console.log(`${action} button clicked for part ID: ${partId}`);
                handleQuantityChange(partId, changeAmount);
            });
        });
        
        // Handle remove item buttons
        document.querySelectorAll('.remove-item-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const partId = this.getAttribute('data-part-id');
                console.log("Remove button clicked for part ID:", partId);
                removeItem(partId);
            });
        });
        
        // Handle quantity changes
        function handleQuantityChange(partId, changeAmount) {
            const quantityElement = document.getElementById(`quantity-${partId}`);
            if (!quantityElement) {
                console.error(`Quantity element not found for part ID: ${partId}`);
                return;
            }
            
            let currentQuantity = parseInt(quantityElement.textContent);
            let newQuantity = currentQuantity + changeAmount;
            
            // Ensure quantity is within reasonable limits (1-10)
            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > 10) newQuantity = 10;
            
            // If quantity didn't change, no need to proceed
            if (currentQuantity === newQuantity) return;
            
            // Update display immediately for better UX
            quantityElement.textContent = newQuantity;
            
            // Recalculate item's total price
            updateItemPrice(partId, newQuantity);
            
            // Send update to server
            updateCartOnServer(partId, newQuantity);
        }
        
        // Update item price in the UI
        function updateItemPrice(partId, quantity) {
            const cartItem = document.querySelector(`.cart-item[data-part-id="${partId}"]`);
            if (!cartItem) return;
            
            const priceElement = cartItem.querySelector('.product-price');
            const itemTotalElement = cartItem.querySelector('.item-total');
            
            if (!priceElement || !itemTotalElement) return;
            
            // Extract price (assuming format: "EGP XXX")
            const priceText = priceElement.textContent.trim();
            const match = priceText.match(/EGP\s+(\d+(\.\d+)?)/);
            
            if (match && match[1]) {
                const price = parseFloat(match[1]);
                const totalPrice = price * quantity;
                
                // Update item total
                itemTotalElement.textContent = `EGP ${totalPrice.toFixed(2)}`;
                
                // Update cart totals
                updateCartTotals();
            }
        }
        
        // Update overall cart totals
        function updateCartTotals() {
            let subtotal = 0;
            
            // Calculate new subtotal
            document.querySelectorAll('.item-total').forEach(element => {
                const priceText = element.textContent.trim();
                const match = priceText.match(/EGP\s+(\d+(\.\d+)?)/);
                
                if (match && match[1]) {
                    subtotal += parseFloat(match[1]);
                }
            });
            
            // Update subtotal and total in summary
            const subtotalElement = document.getElementById('cart-subtotal');
            const totalElement = document.getElementById('cart-total');
            const itemCountElement = document.querySelector('.item-count');
            
            if (subtotalElement) {
                subtotalElement.textContent = `EGP ${subtotal.toFixed(2)}`;
            }
            
            if (totalElement) {
                totalElement.textContent = `EGP ${subtotal.toFixed(2)}`; // Add tax calculation if needed
            }
            
            // Update item count in header if needed
            if (itemCountElement) {
                const itemCount = document.querySelectorAll('.cart-item').length;
                itemCountElement.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
            }
        }
        
        // Send cart updates to the server
        function updateCartOnServer(partId, quantity) {
            fetch(`/cart/update/${partId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: `quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cart updated successfully:', data);
                
                // Update cart count in navigation if exists
                if (data.cart_count !== undefined) {
                    const cartCounters = document.querySelectorAll('#cart-count, #mobile-cart-count');
                    cartCounters.forEach(counter => {
                        if (counter) counter.textContent = data.cart_count;
                    });
                }
                
                // If server sent updated total, use it instead of client calculation
                if (data.total_price !== undefined) {
                    const totalElement = document.getElementById('cart-total');
                    if (totalElement) {
                        totalElement.textContent = `EGP ${data.total_price}`;
                    }
                }
                
                // Show success notification if needed
                if (data.success && window.showNotification) {
                    showNotification('Cart updated');
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                // Revert to original quantity if there was an error
                const quantityElement = document.getElementById(`quantity-${partId}`);
                if (quantityElement && window.showNotification) {
                    showNotification('Failed to update cart. Please try again.', 'error');
                }
            });
        }
        
        // Remove item from cart
        function removeItem(partId) {
            // Find the cart item
            const cartItem = document.querySelector(`.cart-item[data-part-id="${partId}"]`);
            if (!cartItem) return;
            
            // Add removal animation
            cartItem.style.opacity = '0.5';
            cartItem.style.transform = 'translateX(100px)';
            
            // Send remove request to server
            fetch(`/cart/remove/${partId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Item removed successfully:', data);
                
                // Remove the item from DOM
                cartItem.addEventListener('transitionend', function() {
                    cartItem.remove();
                    
                    // Update cart totals
                    updateCartTotals();
                    
                    // Update cart count in navigation
                    if (data.cart_count !== undefined) {
                        const cartCounters = document.querySelectorAll('#cart-count, #mobile-cart-count');
                        cartCounters.forEach(counter => {
                            if (counter) counter.textContent = data.cart_count;
                        });
                    }
                    
                    // Check if cart is empty now
                    if (document.querySelectorAll('.cart-item').length === 0) {
                        location.reload(); // Reload to show empty cart template
                    }
                    
                    // Show success notification if needed
                    if (data.success && window.showNotification) {
                        showNotification('Item removed from cart');
                    }
                });
            })
            .catch(error => {
                console.error('Error removing item:', error);
                
                // Revert animation if there was an error
                cartItem.style.opacity = '1';
                cartItem.style.transform = 'translateX(0)';
                
                if (window.showNotification) {
                    showNotification('Failed to remove item. Please try again.', 'error');
                }
            });
        }
    }
    
    // Discount code functionality
    function setupDiscountCode() {
        const applyBtn = document.getElementById('apply-discount-btn');
        if (applyBtn) {
            applyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const discountInput = document.getElementById('discount-code-input');
                const code = discountInput.value.trim();
                
                if (code) {
                    alert(`Discount code "${code}" applied!`);
                    discountInput.value = '';
                } else {
                    alert('Please enter a discount code');
                }
            });
        }
    }
    
    // Style effects
    function setupStyleEffects() {
        // Edit buttons functionality
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                alert('This feature will be available soon!');
            });
        });
        
        // Add hover effects for buttons
        document.querySelectorAll('.quantity-btn, .remove-item-btn, .edit-btn').forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });
        
        // Add smooth transitions
        document.querySelectorAll('.cart-item').forEach(item => {
            item.style.transition = 'all 0.3s ease';
        });
    }
    
    // Simple notification function (fallback)
    window.showNotification = function(message, type = 'success') {
        if (!document.getElementById('notification-container')) {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            document.body.appendChild(container);
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: ${type === 'success' ? '#4CAF50' : '#F44336'};
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.3s ease;
        `;
        
        document.getElementById('notification-container').appendChild(notification);
        
        // Trigger animation
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(50px)';
            notification.addEventListener('transitionend', function() {
                notification.remove();
            });
        }, 3000);
    };
});
</script>
{% endblock %}

